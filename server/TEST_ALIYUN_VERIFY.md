# 阿里云车辆核验接口测试指南

## 前置准备

### 1. 配置环境变量

在 `server` 目录下创建或编辑 `.env` 文件，配置阿里云密钥：

```bash
ALIYUN_ACCESS_KEY_ID=your_access_key_id
ALIYUN_ACCESS_KEY_SECRET=your_access_key_secret
ALIYUN_ENDPOINT=cloudauth.aliyuncs.com
```

**获取阿里云密钥：**
1. 登录 [阿里云控制台](https://ecs.console.aliyun.com/)
2. 进入「访问控制」->「用户」->「创建用户」
3. 创建 AccessKey，获取 `AccessKey ID` 和 `AccessKey Secret`
4. 确保该用户有「车辆核验」服务的权限

### 2. 安装依赖

确保已安装必要的 Python 包：

```bash
cd server
pip install -r requirements.txt
```

## 运行测试

### 基本测试

运行所有测试（推荐首次测试时使用）：

```bash
cd server
python3 test_aliyun_verify.py
```

### 测试特定类型

#### 测试一致性核验（二要素）
```bash
python3 test_aliyun_verify.py --type consistency --element 2
```

#### 测试一致性核验（三要素）
```bash
python3 test_aliyun_verify.py --type consistency --element 3
```

#### 测试基本信息查询
```bash
python3 test_aliyun_verify.py --type basicInfo
```

#### 测试投保日志查询
```bash
python3 test_aliyun_verify.py --type insuranceLog
```

### 仅检查配置

检查环境变量配置是否正确：

```bash
python3 test_aliyun_verify.py --type config
```

## 测试类型说明

### 1. 一致性核验 (consistency)

验证姓名、车牌号（以及可选的身份证号）是否一致。

- **二要素核验**：姓名 + 车牌号
- **三要素核验**：姓名 + 身份证号 + 车牌号

**测试数据：**
- 姓名：张三
- 车牌号：京A12345
- 车辆类型：02（小型汽车）
- 身份证号（仅三要素）：110101199001011234

### 2. 基本信息查询 (basicInfo)

查询车辆的基本信息，包括：
- 车辆品牌
- 车辆型号
- 发动机号
- 车架号
- 注册日期
- 等

**测试数据：**
- 车牌号：京A12345
- 车辆类型：02

### 3. 投保日志查询 (insuranceLog)

查询车辆的投保历史记录。

**测试数据：**
- 车牌号：京A12345
- 车辆类型：02
- VIN（车辆识别码）：LSGBF53M8DS123456

## 测试结果说明

### 一致性核验结果

- `bizCode = '1'`：✓ 核验结果一致
- `bizCode = '2'`：✗ 核验结果不一致
- `bizCode = '3'`：⚠ 查无记录

### 成功标志

测试通过时会显示：
```
✓ 调用成功
返回结果: {...}
✓ 核验结果: 一致
```

### 失败处理

如果测试失败，会显示错误信息：
```
✗ 调用失败: 错误原因
```

常见错误：
1. **配置未设置**：检查 `.env` 文件中的阿里云密钥配置
2. **权限不足**：确保 AccessKey 有车辆核验服务的权限
3. **网络问题**：检查网络连接和防火墙设置
4. **参数错误**：检查测试数据格式是否正确

## 修改测试数据

如果需要使用自己的测试数据，可以编辑 `test_aliyun_verify.py` 文件中的 `TEST_DATA` 字典：

```python
TEST_DATA = {
    'consistency_2': {
        'name': '你的姓名',
        'idCard': '',  # 二要素核验留空
        'plateNumber': '你的车牌号',
        'vehicleType': '02'  # 02=小型汽车, 01=大型汽车
    },
    # ... 其他测试数据
}
```

## 车辆类型代码

- `01`：大型汽车
- `02`：小型汽车
- `03`：使馆汽车
- `04`：领馆汽车
- `05`：境外汽车
- `06`：外籍汽车
- `07`：普通摩托车
- `08`：轻便摩托车
- `09`：使馆摩托车
- `10`：领馆摩托车
- `11`：境外摩托车
- `12`：外籍摩托车
- `13`：低速车
- `14`：拖拉机
- `15`：挂车
- `16`：教练汽车
- `17`：教练摩托车
- `18`：试验汽车
- `19`：试验摩托车
- `20`：临时入境汽车
- `21`：临时入境摩托车
- `22`：临时行驶车
- `23`：警用汽车
- `24`：警用摩托车

## 注意事项

1. **费用说明**：每次调用阿里云车辆核验接口都会产生费用，请谨慎测试
2. **测试数据**：使用真实有效的车牌号和身份信息进行测试
3. **环境隔离**：建议在测试环境先验证，确认无误后再用于生产环境
4. **日志查看**：测试过程中的详细日志会输出到控制台，便于排查问题

## 故障排查

### 问题：提示"阿里云配置未设置"

**解决方案：**
1. 确认 `.env` 文件存在于 `server` 目录下
2. 检查 `.env` 文件中的配置项名称是否正确
3. 确认配置值不为空

### 问题：提示"API调用失败"

**解决方案：**
1. 检查 AccessKey 是否有车辆核验服务的权限
2. 确认 AccessKey 是否有效（未过期或被禁用）
3. 检查网络连接是否正常
4. 查看详细的错误信息，根据错误码查询阿里云文档

### 问题：测试数据格式错误

**解决方案：**
1. 确认车牌号格式正确（如：京A12345）
2. 确认身份证号为18位数字
3. 确认车辆类型代码正确

## 相关文件

- `test_aliyun_verify.py` - 测试脚本
- `vehicle_verify_helper.py` - 阿里云API封装
- `app.py` - 后端API接口实现
- `env.example` - 环境变量配置示例


