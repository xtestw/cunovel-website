# Token计算准确性验证报告

## 当前实现状态

### 文本Token计算

#### ✅ GPT系列（准确）
- **实现方式**：使用 `tiktoken` 库（官方推荐）
- **模型**：gpt4, gpt4turbo, gpt4o, gpt4omini, gpt4o1, gpt4o1mini, gpt35turbo
- **准确性**：高（使用官方库）
- **回退算法**：有（当库加载失败时使用估算）

#### ⚠️ Claude系列（近似算法）
- **实现方式**：自定义近似算法
- **模型**：claude35Sonnet, claude35Haiku, claude3Opus, claude3Sonnet, claude3Haiku
- **准确性**：中等（基于经验公式）
- **计算公式**：
  - 中文：1字符 = 1 token
  - 英文：1.25 tokens/单词 或 3.3字符/token
  - 其他：2.6字符/token
- **建议**：考虑使用Anthropic官方SDK或API进行验证

#### ⚠️ Gemini系列（近似算法）
- **实现方式**：自定义近似算法
- **模型**：gemini2Flash, gemini15Pro, gemini15Flash, geminiPro
- **准确性**：中等（基于经验公式）
- **计算公式**：
  - 中文：1.15字符/token（SentencePiece分词较细）
  - 英文：1.35 tokens/单词 或 3.6字符/token
  - 其他：2.8字符/token
- **建议**：使用Google的官方tokenizer进行验证

#### ⚠️ Qwen系列（近似算法）
- **实现方式**：自定义近似算法
- **模型**：qwen25, qwenMax, qwen
- **准确性**：中等（基于经验公式）
- **计算公式**：
  - 中文：0.95字符/token（对中文优化最好）
  - 英文：1.28 tokens/单词 或 3.6字符/token
  - 其他：2.8字符/token
- **建议**：使用Qwen官方tokenizer进行验证

#### ⚠️ DeepSeek系列（近似算法）
- **实现方式**：自定义近似算法
- **模型**：deepseekV3, deepseek
- **准确性**：中等（基于经验公式）
- **计算公式**：
  - 中文：0.98字符/token
  - 英文：1.31 tokens/单词 或 3.4字符/token
  - 其他：2.7字符/token
- **建议**：使用DeepSeek官方API进行验证

#### ⚠️ MiniMax系列（近似算法）
- **实现方式**：自定义近似算法
- **模型**：minimaxPro, minimax
- **准确性**：中等（基于经验公式）
- **计算公式**：
  - 中文：1.02字符/token
  - 英文：1.29 tokens/单词 或 3.4字符/token
  - 其他：2.8字符/token
- **建议**：使用MiniMax官方API进行验证

#### ⚠️ Llama/Mistral系列（近似算法）
- **实现方式**：自定义近似算法
- **模型**：llama32, llama31, mistralLarge, mistral
- **准确性**：中等（基于经验公式）
- **计算公式**：
  - 中文：1.35字符/token
  - 英文：1.32 tokens/单词 或 3.8字符/token
  - 其他：2.9字符/token
- **建议**：使用HuggingFace transformers库进行验证

### 图片Token计算

#### ✅ GPT-4 Vision（已验证）
- **实现方式**：基于OpenAI官方公式
- **规则**：
  - Resize：最大边≤2048px，短边≤768px
  - Tiles = ceil(width/512) × ceil(height/512)
  - Tokens = 85 + 170 × Tiles
- **准确性**：高（符合官方文档）
- **测试用例**：
  - 512×512: 85 + 170×1 = 255 tokens ✓
  - 1024×1024: 85 + 170×4 = 765 tokens ✓
  - 2048×768: 85 + 170×8 = 1445 tokens ✓

#### ✅ GPT-4o Vision（已验证）
- **实现方式**：与GPT-4 Vision相同
- **准确性**：高

#### ⚠️ Claude 3.5 Sonnet Vision（需要验证）
- **实现方式**：基于像素数的分段计算
- **规则**：
  - Resize：最大边≤4096px
  - 分段计算：基于像素数范围
- **准确性**：中等（需要与官方文档对比）
- **建议**：验证Anthropic官方文档中的准确公式

#### ⚠️ Claude 3系列Vision（需要验证）
- **实现方式**：与Claude 3.5相同
- **准确性**：中等
- **建议**：验证Anthropic官方文档

#### ⚠️ Gemini Vision系列（需要验证）
- **实现方式**：基于像素数的分段计算
- **准确性**：中等
- **建议**：验证Google官方文档

#### ⚠️ Qwen-VL系列（需要验证）
- **实现方式**：基于patch大小计算
- **准确性**：中等
- **建议**：验证Qwen官方文档

## 发现的问题

### 1. 文本Token计算
- **问题**：除GPT系列外，其他模型都使用近似算法
- **影响**：可能存在5-15%的误差
- **建议**：
  - 优先使用各模型的官方tokenizer库
  - 如果无法使用官方库，通过实际API调用收集数据来校准算法
  - 添加"估算"标识，告知用户这是近似值

### 2. 图片Token计算
- **问题**：部分模型的公式可能不准确
- **影响**：Claude、Gemini等模型的图片token计算可能存在误差
- **建议**：
  - 查阅各模型的最新官方文档
  - 使用实际API调用进行验证
  - 添加测试用例覆盖常见图片尺寸

### 3. 回退机制
- **问题**：当tiktoken库加载失败时，回退到估算算法
- **影响**：GPT系列也可能出现不准确的情况
- **建议**：
  - 确保tiktoken库正确加载
  - 添加库加载失败的警告提示
  - 考虑使用CDN或备用库

## 改进建议

### 短期改进（高优先级）
1. ✅ **保持GPT系列使用tiktoken库**（已实现）
2. ⚠️ **添加"估算"标识**到非GPT模型的计算结果
3. ⚠️ **验证图片token计算公式**，特别是Claude和Gemini系列
4. ⚠️ **添加测试用例**，覆盖常见场景

### 中期改进（中优先级）
1. **集成官方tokenizer库**：
   - Anthropic SDK for Claude
   - Google AI SDK for Gemini
   - Qwen官方tokenizer
   - DeepSeek官方SDK
2. **建立验证机制**：
   - 定期与官方API结果对比
   - 收集用户反馈
   - 自动校准算法参数

### 长期改进（低优先级）
1. **实时API验证**：允许用户选择使用实际API进行验证
2. **批量测试工具**：提供测试套件供用户验证
3. **社区贡献**：允许用户提交校准数据

## 测试建议

### 文本Token测试用例
1. **纯中文**："你好世界"（应≈4 tokens for GPT）
2. **纯英文**："Hello world"（应≈2 tokens for GPT）
3. **混合文本**："Hello 世界"（应≈3 tokens for GPT）
4. **代码片段**：包含特殊字符的代码
5. **长文本**：1000+字符的文本

### 图片Token测试用例
1. **小图**：512×512（基准测试）
2. **中等图**：1024×1024
3. **大图**：2048×2048
4. **超宽图**：4096×512
5. **超高图**：512×4096
6. **需要resize的图**：5000×5000

## 准确性目标

- **GPT系列**：误差 < 1%（使用官方库）
- **其他模型**：误差 < 10%（近似算法）
- **图片Token**：误差 < 5%（基于官方公式）

## 更新日期
2025-11-08

